# name: test/sql/odbc_wstring_support.test
# description: Test ODBC extension wstring/Unicode support
# group: [odbc]

require odbc

statement ok
SET variable odbc_connection = (SELECT CASE platform WHEN 'osx_arm64' THEN 'Driver=SQLite Driver;Database=__TEST_DIR__/unicode_test.db' ELSE 'Driver=DuckDB Driver;Database=__TEST_DIR__/unicode_test.db' END FROM pragma_platform());

# Drop test table if it exists
statement ok
CALL odbc_exec(getvariable('odbc_connection'), sql=>'DROP TABLE IF EXISTS unicode_test;');

# Create a test table with Unicode text
statement ok
CALL odbc_exec(getvariable('odbc_connection'), sql=>'CREATE TABLE unicode_test (
  id INTEGER PRIMARY KEY,
  description TEXT
);');

# Insert multilingual data
statement ok
CALL odbc_exec(getvariable('odbc_connection'), sql=>'INSERT INTO unicode_test VALUES
(1, ''English: Hello World!''),
(2, ''Chinese: ä½ å¥½ï¼Œä¸–ç•Œï¼''),
(3, ''Russian: ĞŸÑ€Ğ¸Ğ²ĞµÑ‚, Ğ¼Ğ¸Ñ€!''),
(4, ''Japanese: ã“ã‚“ã«ã¡ã¯ä¸–ç•Œï¼''),
(5, ''Arabic: Ù…Ø±Ø­Ø¨Ø§ Ø¨Ø§Ù„Ø¹Ø§Ù„Ù…!''),
(6, ''Greek: Î“ÎµÎ¹Î¬ ÏƒÎ¿Ï… ÎšÏŒÏƒÎ¼Îµ!''),
(7, ''Thai: à¸ªà¸§à¸±à¸ªà¸”à¸µà¸Šà¸²à¸§à¹‚à¸¥à¸!''),
(8, ''Hebrew: ×©×œ×•× ×¢×•×œ×!''),
(9, ''Emoji: ğŸ‘‹ğŸŒğŸŒğŸŒâœ¨'');');

# Test Unicode data retrieval with odbc_scan
query IT
SELECT id, description FROM odbc_scan('unicode_test', getvariable('odbc_connection')) ORDER BY id;
----
1	English: Hello World!
2	Chinese: ä½ å¥½ï¼Œä¸–ç•Œï¼
3	Russian: ĞŸÑ€Ğ¸Ğ²ĞµÑ‚, Ğ¼Ğ¸Ñ€!
4	Japanese: ã“ã‚“ã«ã¡ã¯ä¸–ç•Œï¼
5	Arabic: Ù…Ø±Ø­Ø¨Ø§ Ø¨Ø§Ù„Ø¹Ø§Ù„Ù…!
6	Greek: Î“ÎµÎ¹Î¬ ÏƒÎ¿Ï… ÎšÏŒÏƒÎ¼Îµ!
7	Thai: à¸ªà¸§à¸±à¸ªà¸”à¸µà¸Šà¸²à¸§à¹‚à¸¥à¸!
8	Hebrew: ×©×œ×•× ×¢×•×œ×!
9	Emoji: ğŸ‘‹ğŸŒğŸŒğŸŒâœ¨

# Test with odbc_query
query IT
SELECT id, description FROM odbc_query(getvariable('odbc_connection'), 'SELECT * FROM unicode_test ORDER BY id;');
----
1	English: Hello World!
2	Chinese: ä½ å¥½ï¼Œä¸–ç•Œï¼
3	Russian: ĞŸÑ€Ğ¸Ğ²ĞµÑ‚, Ğ¼Ğ¸Ñ€!
4	Japanese: ã“ã‚“ã«ã¡ã¯ä¸–ç•Œï¼
5	Arabic: Ù…Ø±Ø­Ø¨Ø§ Ø¨Ø§Ù„Ø¹Ø§Ù„Ù…!
6	Greek: Î“ÎµÎ¹Î¬ ÏƒÎ¿Ï… ÎšÏŒÏƒÎ¼Îµ!
7	Thai: à¸ªà¸§à¸±à¸ªà¸”à¸µà¸Šà¸²à¸§à¹‚à¸¥à¸!
8	Hebrew: ×©×œ×•× ×¢×•×œ×!
9	Emoji: ğŸ‘‹ğŸŒğŸŒğŸŒâœ¨

# Test with all_varchar parameter
query TT
SELECT id, description FROM odbc_scan('unicode_test', getvariable('odbc_connection'), all_varchar=true) WHERE id::int BETWEEN 2 AND 5 ORDER BY id;
----
2	Chinese: ä½ å¥½ï¼Œä¸–ç•Œï¼
3	Russian: ĞŸÑ€Ğ¸Ğ²ĞµÑ‚, Ğ¼Ğ¸Ñ€!
4	Japanese: ã“ã‚“ã«ã¡ã¯ä¸–ç•Œï¼
5	Arabic: Ù…Ø±Ø­Ø¨Ø§ Ø¨Ø§Ù„Ø¹Ø§Ù„Ù…!

# Test filtering with Unicode text
query I
SELECT id FROM odbc_query(getvariable('odbc_connection'), 'SELECT id FROM unicode_test WHERE description LIKE ''%ä½ å¥½%'';');
----
2

# Test with different subsets of columns
query T
SELECT description FROM odbc_scan('unicode_test', getvariable('odbc_connection')) WHERE id = 9;
----
Emoji: ğŸ‘‹ğŸŒğŸŒğŸŒâœ¨